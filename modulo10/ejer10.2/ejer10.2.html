
<!DOCTYPE html>
<html lang="es">
<head>

	<title>M칩dulo 10 - Tema 2: Ejercicio P2P Opcional</title>

	<meta charset="UTF-8">
	
	<link rel="stylesheet" type="text/css" href="estilos.css">

	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>

	<script type="text/javascript" src="gmaps.js"></script>

	<script type="text/javascript" src="zepto.min.js"></script>	

	<script type="text/javascript">

	var map, lat, lng;
	var camino = [];

	$(function() {

		localStorage.camino = localStorage.camino || JSON.stringify([]);
		camino  = JSON.parse(localStorage.camino);
		
		function enlazarMarcador(e) {

			console.info("enlazarMarcador()");

			map.drawRoute({
				origin: [lat, lng],
				destination: [e.latLng.lat(), e.latLng.lng()],
				travelMode: 'driving',
				strokeColor: '#000000',
				strokeOpacity: 0.6,
				strokeWeight: 5
			});

			lat = e.latLng.lat();
			lng = e.latLng.lng();

			map.addMarker({ lat: lat, lng: lng});
			camino.push([lat, lng]);
			localStorage.camino = JSON.stringify(camino);
		}
		
		function geolocalizar() {

			console.info("geolocalizar()");

			GMaps.geolocate({
				success: function(position) {
					lat = position.coords.latitude; 
					lng = position.coords.longitude;

					map = new GMaps({
						el: '#map',
						lat: lat,
						lng: lng,
						click: enlazarMarcador,
						tap: enlazarMarcador
					});

					if (camino.length == 0) {
						// Coordenada inicial
						map.addMarker({ lat: lat, lng: lng});
						camino.push([lat, lng]);	
						localStorage.camino = JSON.stringify(camino);			
					} else {
						cargar();
					}
					
				},
				error: function(error) {
					alert('Error: ' + error.message);
				},
				not_supported: function() {
					alert("No soporta geolocalizaci칩n");
				}
			});
		}

		function reiniciar() {

			console.info("reiniciar()");

			camino = [];
			localStorage.camino = JSON.stringify([]);
			geolocalizar();
		}

		function cargar() {

			console.info("cargar()");

			camino = JSON.parse(localStorage.camino);

			console.log(camino);

			var puntoActual = camino[0];
			
			// A침adir coordenadas
			for (var i = 1; i < camino.length; i++) {

				map.drawRoute({
					origin: puntoActual,
					destination: camino[i],
					travelMode: 'driving',
					strokeColor: '#000000',
					strokeOpacity: 0.8,
					strokeWeight: 5
				});

				puntoActual = camino[i];

				map.addMarker({ lat: camino[i][0], lng: camino[i][1] });
			};
		}

		$("#reiniciar").on('click', reiniciar);

		geolocalizar();
	});	
	</script>
</head>
<body>
	<div id="boton"><button id="reiniciar">Reiniciar</button></div>
	<h2>Geolocalizaci칩n</h2>
	
	<div id="map"></div>
</body>
</html>